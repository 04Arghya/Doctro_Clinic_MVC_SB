package com.doctorclinic.controller;

import com.doctorclinic.model.Appointment;
import com.doctorclinic.model.Doctor;
import com.doctorclinic.model.User;
import com.doctorclinic.repository.AppointmentRepository;
import com.doctorclinic.repository.DoctorRepository;
import com.doctorclinic.repository.UserRepository;

import jakarta.servlet.http.HttpSession;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;

import java.util.*;
import java.util.stream.Collectors;

@Controller
public class MainController {

    @Autowired
    private UserRepository userRepo;

    @Autowired
    private DoctorRepository doctorRepo;

    @Autowired
    private AppointmentRepository appointmentRepo;

    // üè† Home page
    @GetMapping("/")
    public String showHome() {
        return "index";
    }

    // üßë‚Äç‚öïÔ∏è Signup GET
    @GetMapping("/signup")
    public String signupForm() {
        return "signup";
    }

    // üßë‚Äç‚öïÔ∏è Signup POST
    @PostMapping("/signup")
    public String processSignup(@ModelAttribute User user, Model model) {
        User existing = userRepo.findByEmail(user.getEmail());
        if (existing != null) {
            model.addAttribute("error", "Email already registered.");
            return "signup";
        }
        user.setRole(User.Role.PATIENT);
        userRepo.save(user);
        return "redirect:/login";
    }

    // üîê Login GET
    @GetMapping("/login")
    public String loginForm() {
        return "login";
    }

    // üîê Login POST
    @PostMapping("/login")
    public String processLogin(@RequestParam String email,
                               @RequestParam String password,
                               HttpSession session,
                               Model model) {

        User user = userRepo.findByEmail(email);

        if (user == null || !user.getPassword().equals(password)) {
            model.addAttribute("error", "Invalid credentials.");
            return "login";
        }

        session.setAttribute("loggedInUser", user);

        if (user.getRole() == User.Role.ADMIN) {
            return "redirect:/adminDashboard";
        } else if (user.getRole() == User.Role.DOCTOR) {
            Doctor doctor = doctorRepo.findByUser(user);
            if (doctor == null) {
                model.addAttribute("error", "Doctor profile not found for this user. Please contact admin.");
                session.invalidate();
                return "login";
            }
            return "redirect:/doctorDashboard";
        } else { // PATIENT
            return "redirect:/userDashboard";
        }
    }

    // üìã Admin Dashboard
    @GetMapping("/adminDashboard")
    public String showAdminDashboard(HttpSession session, Model model) {
        User adminUser = (User) session.getAttribute("loggedInUser");
        if (adminUser == null || adminUser.getRole() != User.Role.ADMIN) {
            return "redirect:/login";
        }

        List<Appointment> appointments = appointmentRepo.findAll();
        Map<User, List<String>> patientDoctorMap = new HashMap<>();

        for (Appointment appointment : appointments) {
            User patient = appointment.getUser();
            Doctor doctor = appointment.getDoctor();

            if (patient != null && doctor != null) {
                patientDoctorMap
                        .computeIfAbsent(patient, k -> new ArrayList<>())
                        .add(doctor.getName());
            }
        }

        model.addAttribute("patientDoctorMap", patientDoctorMap);
        model.addAttribute("loggedInUser", adminUser);
        return "adminDashboard";
    }

    // üë®‚Äç‚öïÔ∏è Doctor Dashboard
    @GetMapping("/doctorDashboard")
    public String showDoctorDashboard(HttpSession session, Model model) {
        User doctorUser = (User) session.getAttribute("loggedInUser");

        if (doctorUser == null || doctorUser.getRole() != User.Role.DOCTOR) {
            return "redirect:/login";
        }

        Doctor doctor = doctorRepo.findByUser(doctorUser);
        if (doctor == null) {
            model.addAttribute("error", "Doctor profile not found for your account.");
            session.invalidate();
            return "login";
        }

        List<Appointment> appointments = appointmentRepo.findByDoctor(doctor);

        Set<User> assignedPatientsSet = appointments.stream()
                .map(Appointment::getUser)
                .filter(Objects::nonNull)
                .collect(Collectors.toSet());

        model.addAttribute("appointments", appointments);
        model.addAttribute("assignedPatients", new ArrayList<>(assignedPatientsSet));
        model.addAttribute("doctorName", doctor.getName());
        model.addAttribute("loggedInUser", doctorUser);

        return "doctorDashboard";
    }

    // üë§ User Dashboard
    @GetMapping("/userDashboard")
    public String showUserDashboard(HttpSession session, Model model) {
        User loggedInUser = (User) session.getAttribute("loggedInUser");

        if (loggedInUser == null || loggedInUser.getRole() != User.Role.PATIENT) {
            return "redirect:/login";
        }

        List<Doctor> doctors = doctorRepo.findAll();
        List<Appointment> appointments = appointmentRepo.findByUser(loggedInUser);

        model.addAttribute("doctors", doctors);
        model.addAttribute("appointments", appointments);
        model.addAttribute("loggedInUser", loggedInUser);

        return "userDashboard";
    }

    // üö™ Logout
    @GetMapping("/logout")
    public String logout(HttpSession session) {
        session.invalidate();
        return "redirect:/login";
    }
}